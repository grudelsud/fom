var map;var markersArray=[];var circlesArray=[];var initialLocation=new google.maps.LatLng(45,10);google.load("visualization","1",{packages:["corechart"]});$(document).ready(function(){initialize(initialLocation);loadMarkers(clusterUrl)});function initialize(c){var b={zoom:6,center:c,mapTypeId:google.maps.MapTypeId.HYBRID};var d=[{featureType:"administrative",stylers:[{saturation:51},{lightness:15},{gamma:0.95},{visibility:"on"}]},{featureType:"road",stylers:[{visibility:"off"}]},{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"landscape",stylers:[{hue:"#ff0000"}]},{stylers:[{hue:"#ff0000"},{saturation:-61},{gamma:0.4}]}];map=new google.maps.Map(document.getElementById("map_canvas"),b);map.mapTypes.set("map_style",new google.maps.StyledMapType(d));map.setMapTypeId("map_style");mgr=new MarkerManager(map);google.maps.event.addListener(map,"click",function(e){$("#geo_coords").empty().append("clicked on: "+e.latLng.toString())});map.enableKeyDragZoom({boxStyle:{border:"1px dashed #DDDDDD",backgroundColor:"transparent",opacity:1},veilStyle:{backgroundColor:"#FF776B",opacity:0.5,cursor:"crosshair"},visualEnabled:true,visualPosition:google.maps.ControlPosition.LEFT,visualPositionOffset:new google.maps.Size(35,0),visualPositionIndex:null,visualSprite:"http://maps.gstatic.com/mapfiles/ftr/controls/dragzoom_btn.png",visualSize:new google.maps.Size(20,20),visualTips:{off:"Turn on",on:"Turn off"}});var a=map.getDragZoomObject();google.maps.event.addListener(a,"dragend",function(e){dragZoom(e)})}function loadMarkers(a){$.ajax({url:a,dataType:"json",success:function(b){deleteOverlays();$.each(b,function(d,c){addMarker(c)})}})}function addMarker(a){var b=new google.maps.LatLng(a.meanLat,a.meanLon);marker=new google.maps.Marker({flat:true,position:b,icon:assetsUrl+"/img/lighting_icon.png",map:map,zIndex:2});markersArray.push(marker);google.maps.event.addListener(marker,"click",function(c){deleteCircles();circle=new google.maps.Circle({center:b,clickable:false,fillColor:"#993399",fillOpacity:clusterOpacity(a.posts_meta),map:map,radius:80*clusterArea(a.stdDevLat,a.stdDevLon),strokeColor:"#444444",strokeWeight:1,zIndex:1});circlesArray.push(circle);loadContent(a)})}function showQueryStats(){var a=$("#queries").val();$("#ajax_loader_stats").show();$("#query_meta").empty();$.ajax({url:siteUrl+"/cluster/stat/"+a,dataType:"json",success:function(e){var b=$("<ul></ul>");b.append("<li>topics/cluster: "+e.numberOfTopics+"</li>");b.append("<li>terms/topic: "+e.numberOfWords+"</li>");b.append("<li>min followers:"+e.minFollCount+"</li>");b.append("<li>time granularity: "+e.tGranularity+"</li>");b.append("<li>geo granularity: "+e.geoGranularity+"</li>");b.append("<li>geo clusters: "+e.gClusterNumTot+"</li>");b.append("<li>sem clusters: "+e.sClusterNumTot+"</li>");b.append("<li>tot terms: "+e.termsNumTot+" ("+e.termsNumOverbias+" over a bias of "+e.tfBias+")</li>");var f=$('<div id="div_chart_querystat"></div>');var d=new google.visualization.DataTable();d.addColumn("string","term");d.addColumn("number","frequency");$.each(e.tf,function(g,h){d.addRow([g,h])});$("#query_meta").append(f).append(b).dialog("open");$("#ajax_loader_stats").hide();var c=new google.visualization.BarChart(document.getElementById("div_chart_querystat"));c.draw(d,{width:477,height:240,title:"Query stats",titleTextStyle:{color:"#FFF"},colors:["#FF776B"],backgroundColor:"#333",hAxis:{title:"Frequency",titleTextStyle:{color:"#FFF"},textStyle:{color:"#FFF"},baselineColor:"#FFF"},vAxis:{title:"Term",titleTextStyle:{color:"#FFF"},textStyle:{color:"#FFF"},baselineColor:"#FFF"},legend:"none"})}})}function dragZoom(d){var f=d.getSouthWest().lat();var a=d.getSouthWest().lng();var h=d.getNorthEast().lat();var b=d.getNorthEast().lng();var e=$('<div id="div_clusterstat_form"></div>');var j=$('<div id="div_poststat_form"></div>');var c='<h3>Cluster stats</h3><form name="cluster_stat_form" id="cluster_stat_form" method="post" action="">';c+='<label for="c_since">since:</label><input type="text" name="c_since" id="c_since">';c+='<label for="c_until">until:</label><input type="text" name="c_until" id="c_until">';c+='<input type="submit" name="submit" id="submit" value="Submit">';c+='<input type="hidden" name="swLat" id="swLat" value="'+f+'"><input type="hidden" name="swLon" id="swLon" value="'+a+'">';c+='<input type="hidden" name="neLat" id="neLat" value="'+h+'"><input type="hidden" name="neLon" id="neLon" value="'+b+'"></form>';c+='<div id="div_cluster_stat_result"></div>';var g='<h3>Post stats</h3><form name="post_stat_form" id="post_stat_form" method="post" action="">';g+='<label for="p_since">since:</label><input type="text" name="p_since" id="p_since">';g+='<label for="p_until">until:</label><input type="text" name="p_until" id="p_until">';g+='<label><input class="radio" type="radio" name="p_timespan" value="daily" id="timespan_2" checked> daily</label>';g+='<label><input class="radio" type="radio" name="p_timespan" value="hourly" id="timespan_3"> hourly</label>';
g+='<input type="submit" name="submit" id="submit" value="Submit">';g+='<input type="hidden" name="swLat" id="swLat" value="'+f+'"><input type="hidden" name="swLon" id="swLon" value="'+a+'">';g+='<input type="hidden" name="neLat" id="neLat" value="'+h+'"><input type="hidden" name="neLon" id="neLon" value="'+b+'"></form>';g+='<div id="div_post_stat_result"></div>';e.append(c);j.append(g);$("#content").empty().append(c).fadeIn("fast");$("#post_content").empty().append(g).fadeIn("fast");$("#c_since").live("click",function(){$(this).datepicker({showOn:"focus",dateFormat:"yy-mm-dd"}).focus()});$("#c_until").live("click",function(){$(this).datepicker({showOn:"focus",dateFormat:"yy-mm-dd"}).focus()});$("#p_since").live("click",function(){$(this).datepicker({showOn:"focus",dateFormat:"yy-mm-dd"}).focus()});$("#p_until").live("click",function(){$(this).datepicker({showOn:"focus",dateFormat:"yy-mm-dd"}).focus()});$("#cluster_stat_form").live("submit",function(k){k.preventDefault();showClusterStats()});$("#post_stat_form").live("submit",function(k){k.preventDefault();showPostStats()})}function showClusterStats(){var b=$("#cluster_stat_form").serialize();var a=siteUrl+"/cluster/dzstat/"+b.replace(/&/g,"/");$("#div_cluster_stat_result").empty().html('<img src="'+assetsUrl+'/img/ajax-loader.gif" alt="loading">');$.ajax({url:a,dataType:"json",success:function(c){var e='<img src="'+c.charts.chartUrlPosts+'" alt="chart num posts" />';var d='<img src="'+c.charts.chartUrlClusters+'" alt="chart num posts" />';$("#div_cluster_stat_result").empty().append(e+d)}})}function showPostStats(){var b=$("#post_stat_form").serialize();var a=siteUrl+"/search/dzstat/"+b.replace(/&/g,"/");$("#div_post_stat_result").empty().html('<img src="'+assetsUrl+'/img/ajax-loader.gif" alt="loading">');$.ajax({url:a,dataType:"json",success:function(f){var g="<h3>Result for interval ["+$("#p_since").val()+" - "+$("#p_until").val()+"]</h3>";var e=$("<ul></ul>");var c='<table cellpadding="0" cellspacing="0" border="0" id="datatable">';c+="<thead><tr>";c+='<th width="18%">Date</th>';c+="<th>Tot</th>";c+="<th>EN</th>";c+="<th>IT</th>";c+="<th>FR</th>";c+="<th>ES</th>";c+="<th>DE</th>";c+="<th>PT</th>";c+="<th>Other</th>";c+="</tr></thead>";c+="<tbody></tbody>";c+="</table>";$("#div_post_stat_result").empty().append(g).append(c);var d=$("#datatable").dataTable({bProcessing:true,bLengthChange:false,aaData:f.aaData,aoColumns:[{mDataProp:"date"},{mDataProp:"total"},{mDataProp:"english"},{mDataProp:"italian"},{mDataProp:"french"},{mDataProp:"spanish"},{mDataProp:"german"},{mDataProp:"portuguese"},{mDataProp:"other"}],sDom:"Tlfrtip",oTableTools:{sSwfPath:assetsUrl+"/swf/copy_cvs_xls_pdf.swf",aButtons:["copy","csv"]}})}})}function searchTopics(c,a){var b=siteUrl+"/cluster/search_topic_tf/"+c+"/"+a;$("#ajax_loader_search").show();$.ajax({url:b,dataType:"json",success:function(e){var d=$("<ul></ul>");$.each(e,function(g,j){var f=j.parents;var h=siteUrl+"/cluster/read_list/"+f.replace(/\s/g,"x");d.append('<li><a href="'+h+'" title="'+g+'">'+g+" - "+j.count+" clusters, avg: "+j.score_avg+"</a></li>")});$("#search_result").empty().append(d).show();$("#ajax_loader_search").hide()}})}function DateString(b){function a(d){return d<10?"0"+d:d}var c=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];return b.getUTCFullYear()+"-"+a(b.getUTCMonth()+1)+"-"+a(b.getUTCDate())+"-"+c[b.getUTCDay()]}function createScatter(b,a){$("#ajax_loader_search").show();$.ajax({url:b,dataType:"json",success:function(J){deleteOverlays();var G=new Object;var h=true;var l,q,n=new Array();$.each(J,function(j,g){var K=new Date(Date.parse(g.startTime));var r=DateString(K);if(h==true){l=K;q=K;h=false}else{if(K<l){l=K}if(K>q){q=K}}if(G[r]==undefined){n.push(r);G[r]=new Array(g)}else{G[r].push(g)}});n.sort();$("#legend_content").empty();var d=$("<ul></ul>");var c=$('<div id="div_chart_scatter"></div>');var e=new google.visualization.DataTable();e.addColumn("date","Date");e.addColumn("number","Daily count");e.addColumn("number","Average size");for(var w=0;w<n.length;w++){var D=n[w];var H=G[D];var m=0;var B;for(var x=0;x<H.length;x++){var y=H[x];B=new Date(Date.parse(y.startTime));var k=(B.getTime()-l.getTime())/(1+(q.getTime()-l.getTime()));var u=153;var f=51;var t=153;var s=51;var A=255;var v=51;var p=Math.floor(u-(u-s)*k).toString(16);var z=Math.floor(f-(f-A)*k).toString(16);var F=Math.floor(t-(t-v)*k).toString(16);if(p.length<2){p="0"+p}if(z.length<2){z="0"+z}if(F.length<2){F="0"+F}var C="#"+p+z+F;addBreather(y,C,Math.floor((B.getTime()-l.getTime())/1000),D);m+=y.posts_meta.split(" ").length}var E=Math.floor(100*m/H.length)/100;d.prepend('<li style="background:'+C+'" id="'+D+'">'+D+"<br/>n. "+H.length+" avg. "+E+"</li>");e.addRow([B,H.length,E])}var I='<h3><a href="#" id="legend_toggle_hidden">[Toggle all]</a></h3>';$("#legend_content").append(c).append(I).append(d).dialog("open");$("#ajax_loader_search").hide();var o=new google.visualization.ScatterChart(document.getElementById("div_chart_scatter"));o.draw(e,{width:477,height:240,title:"Results for: "+a,titleTextStyle:{color:"#FFF"},lineWidth:1,pointSize:5,colors:["#FF776B","#30A8C0"],backgroundColor:"#333",hAxis:{title:"Date",titleTextStyle:{color:"#FFF"},textStyle:{color:"#FFF"},baselineColor:"#FFF"},vAxis:{title:"Cluster Info",titleTextStyle:{color:"#FFF"},textStyle:{color:"#FFF"},baselineColor:"#FFF",logScale:true},legend:"right",legendTextStyle:{color:"#FFF"}})
}})}function addBreather(a,g,d,e){var c=new google.maps.LatLng(a.meanLat,a.meanLon);var b=new google.maps.Marker({flat:true,icon:assetsUrl+"/img/lighting_icon.png",position:c,title:e,map:map,zIndex:2});markersArray.push(b);var f=new google.maps.Circle({center:c,clickable:true,fillColor:g,fillOpacity:clusterOpacity(a.posts_meta),map:map,radius:80*clusterArea(a.stdDevLat,a.stdDevLon),strokeColor:"#444444",strokeWeight:1,zIndex:d});circlesArray.push(f);f.scatterCategory=e;google.maps.event.addListener(b,"click",function(h){loadBreatherContent(a)});google.maps.event.addListener(f,"click",function(h){loadBreatherContent(a)})}function clusterOpacity(b){var c=b.split(" ");var a=0.3;if(c.length>10){if(c.length>20){a=0.8}else{a=0.5}}return a}function clusterArea(a,b){return Math.PI*a*b*6400}function dec2degminsec(d){var f=[];var e=(d<0?-1:1);var c=Math.floor(d/1000000)*e;var a=Math.floor(((d/1000000)-Math.floor(d/1000000))*60);var b=Math.floor(((((d/1000000)-Math.floor(d/1000000))*60)-Math.floor(((d/1000000)-Math.floor(d/1000000))*60))*100000)*60/100000;f.push(c);f.push(a);f.push(b);return f}function loadBreatherContent(a){loadContent(a);var b="<h3>Time info</h3><ul><li>from: "+a.startTime+"</li><li>until: "+a.endTime+"</li></ul>";$("#content").append(b)}function loadContent(l){var h=Math.round(l.meanLat*1000)/1000;var a=Math.round(l.meanLon*1000)/1000;var j=Math.round(l.stdDevLat*1000)/1000;var b=Math.round(l.stdDevLon*1000)/1000;var c=Math.round(clusterArea(j,b)*1000)/1000;var f=80*(j+b)/2;var g="<h3>Cluster Meta</h3>";g+='<ul class="cluster_meta"><li>geo: &mu; ['+h+", "+a+"] - &sigma; ["+j+", "+b+"]</li>";g+="<li>radius: "+f+" km, surface: "+c+" km<sup>2</sup></li></ul>";g+='<h3 class="cluster_topics">Topics</h3>';$("#post_content").empty().fadeOut("fast");$("#content").empty().append(g).fadeIn("fast");$.ajax({url:siteUrl+"/cluster/read_semantic/"+l.id_cluster,dataType:"json",success:function(r){var o=Array();var n=Array();$.each(r,function(t,s){var w=Math.round(s.score*1000)/1000;var v=s.terms_meta;var u="";$.each(v,function(x,y){u+=x+" ("+Math.round(y*100)/100+") "});o[w]=u;n.push(w)});var m=$('<ul class="cluster_topics"></ul>');n.sort(function(t,s){return s-t});for(var q=0;q<n.length;q++){var p=n[q];m.append("<li>[score: "+p+"] "+o[p]+"</li>")}$("h3.cluster_topics").after(m)}});$.ajax({url:siteUrl+"/cluster/read_keywords/"+l.id_cluster,dataType:"json",success:function(n){var m=$('<ul class="cluster_topics"></ul>');$.each(n,function(p,o){var r=o.terms_meta;var q="";$.each(r,function(s,t){q+=s+" ("+Math.round(t*100)/100+") "});m.append("<li>keywords: "+q+"</li>")});$("h3.cluster_topics").after(m)}});var e="";var k=(l.posts_meta).split(" ");for(i in k){e+='<a href="'+siteUrl+"/cluster/read_post/"+k[i]+'" class="postUrl">'+i+"</a> "}var d='<a href="'+siteUrl+"/cluster/export_posts/"+l.id_cluster+'/csv">export</a> ';$("#content").append('<h3 class="cluster_posts">Post list [total: '+k.length+" - "+d+"]:</h3><p>"+e+"</p>")}function loadClusterContent(a){$("#post_content").empty().fadeIn("fast");$.ajax({url:a,dataType:"json",success:function(d){var c="<h3>Post Content</h3><p>"+d.content+"</p>";c+='<h3>Meta</h3><ul class="post_meta"><li>coordinates: ['+d.lat+", "+d.lon+"]</li>";if(d.coordinates_estimated==1){c+="<li>user location: "+d.user_location+"</li>"}c+="</ul>";if(d.links){var b="";var e=($.trim(d.links)).split(" ");for(i in e){b+='<a href="'+siteUrl+"/cluster/read_link/"+e[i]+'">'+i+"</a> "}c+="<h3>Links</h3><p>"+b+'</p><p class="link_content"></p>'}$("#post_content").append(c)}})}function loadLinkContent(a){$.ajax({url:a,dataType:"json",success:function(b){$("p.link_content").empty().append('<a href="'+b.uri+'">[url]</a> '+b.text)}})}function setBounds(){if(markersArray){var g=0,b=0,j=0,d=0;for(i in markersArray){var c=markersArray[i].position.lat();var f=markersArray[i].position.lon();if(c<g){g=c}else{if(c>j){j=c}}if(f<b){b=f}else{if(f>d){d=f}}}}var e=new google.maps.LatLng(g,b);var h=new google.maps.LatLng(j,d);var a=new google.maps.LatLngBounds(e,h);map.fitBounds(a)}function clearOverlays(){if(markersArray){for(i in markersArray){markersArray[i].setMap(null)}}if(circlesArray){for(i in circlesArray){circlesArray[i].setMap(null)}}}function showOverlays(){if(markersArray){for(i in markersArray){markersArray[i].setMap(map)}}if(circlesArray){for(i in circlesArray){circlesArray[i].setMap(map)}}}function deleteOverlays(){if(markersArray){for(i in markersArray){markersArray[i].setMap(null)}markersArray.length=0}if(circlesArray){for(i in circlesArray){circlesArray[i].setMap(null)}circlesArray.length=0}}function deleteCircles(){if(circlesArray){for(i in circlesArray){circlesArray[i].setMap(null)}circlesArray.length=0}};